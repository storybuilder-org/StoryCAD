name: Build & Release

on:
  push:
    branches: [main, dev]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '**/*.{png,jpg,jpeg,svg,gif}'
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '**/*.{png,jpg,jpeg,svg,gif}'
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag / version (e.g. v4.0.0)'
        required: true
        type: string
      skip_release:
        description: 'Skip creating a release (build only)'
        required: false
        type: boolean
        default: true
permissions:
  contents: write

concurrency:
  group: storycad-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_version: ${{ steps.version.outputs.tag_version }}
    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_RESTORE_LOCKED_MODE: false
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            fw: net10.0-windows10.0.22621.0
            art: win-x64
            platform: x64
            binary_name: StoryCAD.exe
          - os: windows-latest
            rid: win-arm64
            fw: net10.0-windows10.0.22621.0
            art: win-arm64
            platform: ARM64
            binary_name: StoryCAD.exe
          - os: windows-latest
            rid: win-x86
            fw: net10.0-windows10.0.22621.0
            art: win-x86
            platform: x86
            binary_name: StoryCAD.exe
          - os: macos-latest
            rid: osx-arm64
            fw: net10.0-desktop
            art: osx-arm64
            platform: arm64
            binary_name: StoryCAD.app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'
          global-json-file: './global.json'
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json

      - name: Install Uno macOS workload
        if: matrix.os == 'macos-latest'
        run: dotnet workload install macos
        
      - name: Generate version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            if ("${{ github.event.inputs.skip_release }}" -eq "false") {
              # Release mode: use version verbatim
              $v = "${{ github.event.inputs.version }}".TrimStart('v')
            } else {
              # Draft mode: use major.minor.run_number.65534
              $parts = "${{ github.event.inputs.version }}".TrimStart('v').Split('.')
              $v = "$($parts[0]).$($parts[1]).${{ github.run_number }}.65534"
            }
          } else {
            $v = "1.0.${{ github.run_number }}.65534"
          }
          "version=$v"       >> $env:GITHUB_OUTPUT
          "tag_version=v$v"  >> $env:GITHUB_OUTPUT
          Write-Host "Generated version: $v"
          
      - name: Restore
        run: dotnet restore StoryCAD.sln

      - name: Update Package.appxmanifest version (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $manifestPath = Join-Path "${{ github.workspace }}" "StoryCAD\Package.appxmanifest"
          [xml]$xml = Get-Content $manifestPath
          $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
          $ns.AddNamespace('ns', $xml.DocumentElement.NamespaceURI)
          $identity = $xml.SelectSingleNode('/ns:Package/ns:Identity', $ns)
          $identity.SetAttribute('Version', '${{ steps.version.outputs.version }}')
          $xml.Save($manifestPath)
          Write-Host "Updated manifest version to ${{ steps.version.outputs.version }}"

      - name: Update StoryCADLib.csproj version
        shell: pwsh
        run: |
          $csprojPath = Join-Path "${{ github.workspace }}" "StoryCADLib\StoryCADLib.csproj"
          [xml]$xml = Get-Content $csprojPath
          $versionNode = $xml.SelectSingleNode('//Version')
          $assemblyVersionNode = $xml.SelectSingleNode('//AssemblyVersion')
          $fileVersionNode = $xml.SelectSingleNode('//FileVersion')
          if ($versionNode) { $versionNode.InnerText = '${{ steps.version.outputs.version }}' }
          if ($assemblyVersionNode) { $assemblyVersionNode.InnerText = '${{ steps.version.outputs.version }}' }
          if ($fileVersionNode) { $fileVersionNode.InnerText = '${{ steps.version.outputs.version }}' }
          $xml.Save($csprojPath)
          Write-Host "Updated StoryCADLib.csproj version to ${{ steps.version.outputs.version }}"

      - name: Decode real PFX and write .env (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if ("${{ secrets.BASE64_ENCODED_PFX }}".Length -eq 0) {
            throw "Real PFX not available. Forked PRs cannot access secrets."
          }
          $bytes = [Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_PFX }}")
          $pfxPath = "${{ github.workspace }}\StoryCAD\GitHubActionsWorkflow.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)
          if ("${{ secrets.ENV }}".Length -gt 0) {
            [IO.File]::WriteAllText("${{ github.workspace }}\StoryCAD\.env", "${{ secrets.ENV }}")
            [IO.File]::WriteAllText("${{ github.workspace }}\StoryCADTests\.env", "${{ secrets.ENV }}")
          }

      - name: Run tests (Windows x64)
        if: matrix.os == 'windows-latest' && matrix.platform == 'x64'
        run: dotnet test --project StoryCADTests/StoryCADTests.csproj --configuration Release --no-restore -p:Platform=${{ matrix.platform }}

      - name: Write .env (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          if [ -n "${{ secrets.ENV }}" ]; then
            echo "${{ secrets.ENV }}" > "${{ github.workspace }}/StoryCAD/.env"
            echo "${{ secrets.ENV }}" > "${{ github.workspace }}/StoryCADTests/.env"
          fi

      - name: Run all tests (macOS)
        if: matrix.os == 'macos-latest'
        run: dotnet test --project StoryCADTests/StoryCADTests.csproj --configuration Release --no-restore

      # 10 ─ Setup MSBuild (Windows only)
      - name: Setup MSBuild
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      # 11 ─ Build MSIX package (Windows only)
      - name: Create MSIX package
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $pfx = "${{ github.workspace }}\StoryCAD\GitHubActionsWorkflow.pfx"
          if (-not (Test-Path $pfx)) { throw "PFX missing. Cannot sign MSIX." }
          $msbuildArgs = @(
            'StoryCAD.sln',
            '/m',
            '/p:Configuration=Release',
            '/p:Platform=${{ matrix.platform }}',
            '/p:UapAppxPackageBuildMode=SideloadOnly',
            '/p:AppxBundle=Never',
            "/p:PackageCertificateKeyFile=$pfx",
            "/p:AppxPackageDir=${{ github.workspace }}\StoryCAD\Packages\",
            '/p:GenerateAppxPackageOnBuild=true',
            '/p:PublishReadyToRun=false'
          )
          if ("${{ secrets.PFX_PASSWORD }}".Length -gt 0) {
            $msbuildArgs += "/p:PackageCertificatePassword=${{ secrets.PFX_PASSWORD }}"
          }
          & msbuild @msbuildArgs

      - name: Remove PFX and .env (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        continue-on-error: true
        run: |
          Remove-Item "${{ github.workspace }}\StoryCAD\GitHubActionsWorkflow.pfx" -Force -ErrorAction SilentlyContinue
          Remove-Item "${{ github.workspace }}\StoryCAD\.env","${{ github.workspace }}\StoryCADTests\.env" -Force -ErrorAction SilentlyContinue

      - name: Remove .env (macOS)
        if: matrix.os == 'macos-latest'
        continue-on-error: true
        run: |
          rm -f "${{ github.workspace }}/StoryCAD/.env"
          rm -f "${{ github.workspace }}/StoryCADTests/.env"

      - name: Publish macOS package
        if: matrix.os == 'macos-latest'
        run: |
          PUBLISH_DIR="${{ github.workspace }}/StoryCAD/bin/Release/${{ matrix.fw }}/${{ matrix.rid }}/publish"
          dotnet publish StoryCAD/StoryCAD.csproj \
            -f ${{ matrix.fw }} \
            -r ${{ matrix.rid }} \
            -c Release \
            -p:PackageFormat=pkg \
            -p:SelfContained=true \
            -p:AppBundlePath="${PUBLISH_DIR}/StoryCAD.app"
          cp "${PUBLISH_DIR}/StoryCAD.pkg" storycad-${{ matrix.art }}.pkg

      - name: Zip MSIX artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $zipName = "storycad-msix-${{ matrix.art }}.zip"
          Compress-Archive -Path "${{ github.workspace }}\StoryCAD\Packages\*" -DestinationPath $zipName -Force

      - name: Upload MSIX (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: storycad-msix-${{ matrix.art }}
          path: storycad-msix-${{ matrix.art }}.zip
          if-no-files-found: error

      - name: Upload PKG (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: storycad-${{ matrix.art }}
          path: storycad-${{ matrix.art }}.pkg
          if-no-files-found: error

  release:
    needs: build
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag_version }}
          name: Release ${{ needs.build.outputs.tag_version }}
          files: |
            storycad-msix-win-x64/storycad-msix-win-x64.zip
            storycad-msix-win-arm64/storycad-msix-win-arm64.zip
            storycad-msix-win-x86/storycad-msix-win-x86.zip
            storycad-osx-arm64/storycad-osx-arm64.pkg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
