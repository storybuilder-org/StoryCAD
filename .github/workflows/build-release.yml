name: Build & Release

on:
  push:
    branches:
      - UNOTestBranch
  pull_request:
    branches:
      - UNOTestBranch
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag / version (e.g. v4.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # ---------- BUILD ----------
  build:
    runs-on: ${{ matrix.os }}
    env:
      DOTNET_RESTORE_LOCKED_MODE: false
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            fw: net9.0-windows10.0.22621.0
            art: win-x64
            platform: x64
            binary_name: StoryCAD.exe
          - os: windows-latest
            rid: win-arm64
            fw: net9.0-windows10.0.22621.0
            art: win-arm64
            platform: ARM64
            binary_name: StoryCAD.exe
          - os: windows-latest
            rid: win-x86
            fw: net9.0-windows10.0.22621.0
            art: win-x86
            platform: x86
            binary_name: StoryCAD.exe
          - os: macos-latest
            rid: osx-arm64
            fw: net9.0-desktop
            art: osx-arm64
            platform: arm64
            binary_name: StoryCAD.app
    steps:
      # 1 ─ Checkout repository
      - name: Checkout StoryCAD
        uses: actions/checkout@v4

      # 2 ─ Install the .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # 3 ─ Cache NuGet packages
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 4 ─ Install required workloads for UNO
      - name: Install .NET workloads
        run: dotnet workload install macos

      # 5 ─ Generate version number
      - name: Generate version number
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            # Manual trigger with version input
            $inputVersion = "${{ github.event.inputs.version }}"
            $parts = $inputVersion.TrimStart('v').Split('.')
            $newVersion = "$($parts[0]).$($parts[1]).${{ github.run_number }}.65534"
          } else {
            # Automatic trigger - use version from csproj
            $newVersion = "1.0.${{ github.run_number }}.65534"
          }
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "tag_version=v$newVersion" >> $env:GITHUB_OUTPUT
          Write-Host "Generated version: $newVersion"

      # 6 ─ Update Package.appxmanifest version (Windows only)
      - name: Update Package.appxmanifest version
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $manifestPath = "${{ github.workspace }}\StoryCAD\Package.appxmanifest"
          $content = Get-Content $manifestPath -Raw
          $versionRegex = ' Version="\d+\.\d+\.\d+\.\d+"'
          $newVersionAttr = ' Version="${{ steps.version.outputs.version }}"'
          $content = $content -replace $versionRegex, $newVersionAttr
          Set-Content -Path $manifestPath -Value $content -NoNewline
          Write-Host "Updated manifest version to ${{ steps.version.outputs.version }}"

      # 7 ─ Decode PFX certificate (Windows only)
      - name: Decode PFX certificate
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_PFX }}")
          $pfxPath = "${{ github.workspace }}\StoryCAD\GitHubActionsWorkflow.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)
          Write-Host "PFX certificate decoded"

      # 8 ─ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore StoryCAD.sln

      # 9 ─ Run tests (all platforms)
      - name: Run all tests (Windows)
        if: matrix.os == 'windows-latest'
        run: dotnet test StoryCADTests/StoryCADTests.csproj --configuration Release --no-restore -p:Platform=${{ matrix.platform }}

      - name: Run all tests (macOS)
        if: matrix.os == 'macos-latest'
        run: dotnet test StoryCADTests/StoryCADTests.csproj --configuration Release --no-restore

      # 10 ─ Setup MSBuild (Windows only)
      - name: Setup MSBuild
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      # 11 ─ Build MSIX package (Windows only)
      - name: Create MSIX package
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          msbuild StoryCAD.sln `
            /p:Configuration=Release `
            /p:Platform=${{ matrix.platform }} `
            /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxBundle=Never `
            /p:PackageCertificateKeyFile="${{ github.workspace }}\StoryCAD\GitHubActionsWorkflow.pfx" `
            /p:AppxPackageDir="${{ github.workspace }}\StoryCAD\Packages\" `
            /p:GenerateAppxPackageOnBuild=true

      # 12 ─ Run MSIX Cleaner (Windows only)
      - name: Run MSIX Cleaner
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          ${{ github.workspace }}\.github\workflows\MSIX.ps1 -TargetDirectory "${{ github.workspace }}\StoryCAD\Packages"

      # 13 ─ Remove PFX certificate (Windows only)
      - name: Remove PFX certificate
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Remove-Item -Path "${{ github.workspace }}\StoryCAD\GitHubActionsWorkflow.pfx" -Force
          Write-Host "PFX certificate removed"

      # 14 ─ Clean publish directory (macOS)
      - name: Clean publish directory (macOS)
        if: matrix.os == 'macos-latest'
        run: rm -rf publish

      # 15 ─ Publish (macOS)
      - name: Publish (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          dotnet publish StoryCAD/StoryCAD.csproj \
            -c Release \
            -f ${{ matrix.fw }} \
            -r ${{ matrix.rid }} \
            --self-contained \
            -o publish

      # 16 ─ Apply font fix for macOS (UNO Platform)
      - name: Apply font fix for macOS
        if: matrix.os == 'macos-latest'
        run: |
          # Create the complete App bundle structure
          mkdir -p publish/StoryCAD.app/Contents/MacOS
          mkdir -p publish/StoryCAD.app/Contents/Resources

          # Copy all application files to MacOS directory
          cp -R publish/* publish/StoryCAD.app/Contents/MacOS/ 2>/dev/null || true

          # Copy resources (fonts, etc.) into the bundle Resources directory
          if [ -d publish/Resources ]; then
            cp -R publish/Resources/* publish/StoryCAD.app/Contents/Resources/
          fi

          # Ensure Uno.Fonts.Fluent fonts are copied to the expected location
          if [ -d publish/Uno.Fonts.Fluent/Fonts ]; then
            mkdir -p publish/StoryCAD.app/Contents/MacOS/Uno.Fonts.Fluent/Fonts
            cp publish/Uno.Fonts.Fluent/Fonts/* publish/StoryCAD.app/Contents/MacOS/Uno.Fonts.Fluent/Fonts/
          fi

          # Remove the app bundle from itself (avoid recursion)
          rm -rf publish/StoryCAD.app/Contents/MacOS/StoryCAD.app

          # Verify the font file exists where the app expects it
          echo "Font file verification:"
          find publish/StoryCAD.app/Contents/MacOS -name "*uno-fluentui-assets.ttf*" -ls

          # Verify the structure was created
          echo "App bundle structure:"
          ls -la publish/StoryCAD.app/Contents/
          echo "MacOS contents:"
          ls -la publish/StoryCAD.app/Contents/MacOS/ | head -10

      # 17 ─ Create custom PKG with font fix for macOS
      - name: Create macOS PKG
        if: matrix.os == 'macos-latest'
        run: |
          # Create package build structure
          mkdir -p pkg-build/Applications
          cp -R publish/StoryCAD.app pkg-build/Applications/

          # Create the PKG installer
          pkgbuild --root pkg-build \
            --identifier org.storybuilder.storycad \
            --version ${{ steps.version.outputs.version }} \
            --install-location / \
            storycad-${{ matrix.art }}.pkg

      # 18 ─ Package Windows MSIX artifacts
      - name: Package Windows MSIX artifact
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $zipName = "storycad-msix-${{ matrix.art }}.zip"
          Compress-Archive -Path "${{ github.workspace }}\StoryCAD\Packages\*" -DestinationPath $zipName -Force
          Write-Host "Created $zipName"

      # 19 ─ Upload artifacts
      - name: Upload MSIX artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: storycad-msix-${{ matrix.art }}
          path: storycad-msix-${{ matrix.art }}.zip

      - name: Upload build artifacts (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: storycad-${{ matrix.art }}
          path: storycad-${{ matrix.art }}.pkg

  # ---------- RELEASE ----------
  release:
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout for version calculation
        uses: actions/checkout@v4

      - name: Calculate release version
        id: release_version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $inputVersion = "${{ github.event.inputs.version }}"
            $parts = $inputVersion.TrimStart('v').Split('.')
            $version = "$($parts[0]).$($parts[1]).${{ github.run_number }}.65534"
            $tagVersion = "v$version"
          } else {
            $version = "1.0.${{ github.run_number }}.65534"
            $tagVersion = "v$version"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag_version=$tagVersion" >> $env:GITHUB_OUTPUT
          Write-Host "Release version: $tagVersion"

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_version.outputs.tag_version }}
          name: Release ${{ steps.release_version.outputs.tag_version }}
          files: |
            storycad-msix-win-x64/storycad-msix-win-x64.zip
            storycad-msix-win-arm64/storycad-msix-win-arm64.zip
            storycad-msix-win-x86/storycad-msix-win-x86.zip
            storycad-osx-arm64/storycad-osx-arm64.pkg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
