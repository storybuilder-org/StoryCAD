<Page NavigationCacheMode="Required"
      x:Class="StoryCAD.Views.ProblemPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:usercontrols="using:StoryCADLib.Controls"
      xmlns:viewModels="using:StoryCADLib.ViewModels"
      xmlns:tools="using:StoryCADLib.ViewModels.Tools"
      ScrollViewer.VerticalScrollBarVisibility="Disabled"
      ScrollViewer.HorizontalScrollBarVisibility="Disabled">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <TextBox Header="Name" Text="{x:Bind ProblemVm.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 viewModels:TextBoxFocus.IsFocused="{x:Bind ProblemVm.IsTextBoxFocused, Mode=TwoWay}"
                 Margin="10,10,10,0" />
        <TabView Grid.Row="1" TabWidthMode="Equal" CanDragTabs="False" CanReorderTabs="False" IsAddTabButtonVisible="False"
                 HorizontalAlignment="Stretch"
                 VerticalAlignment="Stretch"
                 HorizontalContentAlignment="Stretch"
                 VerticalContentAlignment="Stretch">
            <TabView.TabItems>
                <TabViewItem Header="Problem" IsClosable="False"
                             HorizontalContentAlignment="Stretch"
                             VerticalContentAlignment="Stretch">
                    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid Grid.Row="0" HorizontalAlignment="Left">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="2*" />
                            </Grid.ColumnDefinitions>
                            <ComboBox Grid.Column="0" IsEditable="True" Header="Problem Type" Grid.Row="0" MinWidth="200"
                                  ItemsSource="{x:Bind ProblemVm.ProblemTypeList}"
                                  Text="{x:Bind ProblemVm.ProblemType, Mode=TwoWay}"
                                  PlaceholderText="{x:Bind ProblemVm.ProblemType, Mode=TwoWay}" />
                            <ComboBox Grid.Column="2" IsEditable="True" Header="Conflict Type" Grid.Row="0" MinWidth="200"
                                  Margin="20,0,0,0"
                                  ItemsSource="{x:Bind ProblemVm.ConflictTypeList}"
                                  Text="{x:Bind ProblemVm.ConflictType, Mode=TwoWay}"
                                  PlaceholderText="{x:Bind ProblemVm.ConflictType, Mode=TwoWay}" />
                        </Grid>
                        <ComboBox IsEditable="True" Header="Problem Category" Grid.Row="1" MinWidth="300"
                              ItemsSource="{x:Bind ProblemVm.ProblemCategoryList}"
                              Text="{x:Bind ProblemVm.ProblemCategory, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.ProblemCategory, Mode=TwoWay}" />
                        <ComboBox IsEditable="True" Header="Subject" Grid.Row="2" MinWidth="300"
                              ItemsSource="{x:Bind ProblemVm.SubjectList}"
                              Text="{x:Bind ProblemVm.Subject, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.Subject, Mode=TwoWay}" />
                        <usercontrols:RichEditBoxExtended Header="Story Question" Grid.Row="3"
                                                      RtfText="{x:Bind ProblemVm.Description, Mode=TwoWay}"
                                                      AcceptsReturn="True"
                                                      IsSpellCheckEnabled="True" TextWrapping="Wrap"
                                                      VerticalAlignment="Stretch"
                                                      ScrollViewer.VerticalScrollBarVisibility="Auto" />
                        <ComboBox IsEditable="True" Header="Problem Source" Grid.Row="4" MinWidth="300"
                              ItemsSource="{x:Bind ProblemVm.ProblemSourceList}"
                              Text="{x:Bind ProblemVm.ProblemSource, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.ProblemSource, Mode=TwoWay}" />
                    </Grid>
                </TabViewItem>
                <TabViewItem Header="Protagonist" IsClosable="False"
                             HorizontalContentAlignment="Stretch"
                             VerticalContentAlignment="Stretch">
                    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <ComboBox Header="Protagonist" Grid.Row="0" IsEditable="False" MinWidth="300"
                              DisplayMemberPath="Name"
                              SelectedItem="{x:Bind ProblemVm.SelectedProtagonist, Mode=TwoWay}"
                              ItemsSource="{x:Bind ProblemVm.Characters, Mode=OneWay}" />
                        <ComboBox IsEditable="True" Header="Goal" Grid.Row="1"
                              MinWidth="400" ItemsSource="{x:Bind ProblemVm.GoalList}"
                              Text="{x:Bind ProblemVm.ProtGoal, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.ProtGoal, Mode=TwoWay}" />
                        <ComboBox IsEditable="True" Header="Motivation" Grid.Row="2"
                              MinWidth="300" ItemsSource="{x:Bind ProblemVm.MotiveList}"
                              Text="{x:Bind ProblemVm.ProtMotive, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.ProtMotive, Mode=TwoWay}" />
                        <Button Content="Conflict Builder" Grid.Row="3" HorizontalAlignment="Left" Margin="0,10,10,10"
                            Command="{x:Bind ProblemVm.ConflictCommand, Mode=OneWay}" />
                        <usercontrols:RichEditBoxExtended Header="Conflict" Grid.Row="4"
                                                      RtfText="{x:Bind ProblemVm.ProtConflict, Mode=TwoWay}"
                                                      AcceptsReturn="True"
                                                      IsSpellCheckEnabled="True" TextWrapping="Wrap"
                                                      VerticalAlignment="Stretch"
                                                      ScrollViewer.VerticalScrollBarVisibility="Auto" />
                    </Grid>
                </TabViewItem>
                <TabViewItem Header="Antagonist" IsClosable="False"
                             HorizontalContentAlignment="Stretch"
                             VerticalContentAlignment="Stretch">
                    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <ComboBox Header="Antagonist" Grid.Row="0" IsEditable="False" MinWidth="300"
                              DisplayMemberPath="Name"
                              SelectedItem="{x:Bind ProblemVm.SelectedAntagonist, Mode=TwoWay}"
                              SelectedValuePath="Uuid"
                              ItemsSource="{x:Bind ProblemVm.Characters, Mode=OneWay}" />
                        <ComboBox IsEditable="True" Header="Goal" Grid.Row="1"
                              MinWidth="400" ItemsSource="{x:Bind ProblemVm.GoalList}"
                              Text="{x:Bind ProblemVm.AntagGoal, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.AntagGoal, Mode=TwoWay}" />
                        <ComboBox IsEditable="True" Header="Motivation" Grid.Row="2"
                              MinWidth="300" ItemsSource="{x:Bind ProblemVm.MotiveList}"
                              Text="{x:Bind ProblemVm.AntagMotive, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.AntagMotive, Mode=TwoWay}" />
                        <Button Content="Conflict Builder" Grid.Row="3" HorizontalAlignment="Left" Margin="0,10,10,10"
                            Command="{x:Bind ProblemVm.ConflictCommand, Mode=OneWay}" />
                        <usercontrols:RichEditBoxExtended Header="Conflict" Grid.Row="4"
                                                      RtfText="{x:Bind ProblemVm.AntagConflict, Mode=TwoWay}"
                                                      AcceptsReturn="True"
                                                      IsSpellCheckEnabled="True" TextWrapping="Wrap"
                                                      VerticalAlignment="Stretch"
                                                      ScrollViewer.VerticalScrollBarVisibility="Auto" />
                    </Grid>
                </TabViewItem>
                <TabViewItem Header="Resolution" IsClosable="False"
                             HorizontalContentAlignment="Stretch"
                             VerticalContentAlignment="Stretch">
                    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <ComboBox IsEditable="True" Header="Outcome" Grid.Row="0"
                              MinWidth="400" ItemsSource="{x:Bind ProblemVm.OutcomeList}"
                              Text="{x:Bind ProblemVm.Outcome, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.Outcome, Mode=TwoWay}" />
                        <ComboBox IsEditable="True" Header="Method" Grid.Row="1"
                              MinWidth="400" ItemsSource="{x:Bind ProblemVm.MethodList}"
                              Text="{x:Bind ProblemVm.Method, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.Method, Mode=TwoWay}" />
                        <ComboBox IsEditable="True" Header="Theme" Grid.Row="2"
                              MinWidth="400" ItemsSource="{x:Bind ProblemVm.ThemeList}"
                              Text="{x:Bind ProblemVm.Theme, Mode=TwoWay}"
                              PlaceholderText="{x:Bind ProblemVm.Theme, Mode=TwoWay}" />
                        <usercontrols:RichEditBoxExtended Header="Premise" Grid.Row="3"
                                                      RtfText="{x:Bind ProblemVm.Premise, Mode=TwoWay}"
                                                      AcceptsReturn="True"
                                                      IsSpellCheckEnabled="True" TextWrapping="Wrap"
                                                      VerticalAlignment="Stretch"
                                                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                      PlaceholderText="A [character] in a situation [genre, setting] wants something [goal], which brings him into [conflict] with a second character [opposition]. After [a series of conflicts], the [final battle] erupts, and [the protagonist] finally [resolves] the conflict. " />
                    </Grid>
                </TabViewItem>

                <TabViewItem Header="Structure" IsClosable="False"
             HorizontalContentAlignment="Stretch"
             VerticalContentAlignment="Stretch">

                    <Grid HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch"
          RowSpacing="8">

                        <Grid.RowDefinitions>
                            <!-- Beat sheet selector + description -->
                            <RowDefinition Height="Auto" />
                            <!-- Beats | commands | elements -->
                            <RowDefinition Height="2*" />
                            <!-- Descriptions -->
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- ===== ROW 0 : BEAT SHEET PICKER (same bindings as before) ===== -->
                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- same Expander + ComboBox + description as original, just isolated in its own row -->
                            <Expander Margin="0,0,0,8"
                      HorizontalAlignment="Stretch">
                                <Expander.Header>
                                    <ComboBox Header="Beat Sheet (Click to show description)"
                              ItemsSource="{x:Bind BeatSheetsViewModel.PlotPatternNames}"
                              SelectionChanged="{x:Bind ProblemVm.UpdateSelectedBeat}"
                              PlaceholderText="{x:Bind ProblemVm.StructureModelTitle, Mode=OneWay}"
                              SelectedValue="{x:Bind ProblemVm.StructureModelTitle, Mode=OneWay}"
                              Text="{x:Bind ProblemVm.StructureModelTitle, Mode=OneWay}" />
                                </Expander.Header>
                                <Expander.Content>
                                    <usercontrols:RichEditBoxExtended
                        Header="Beat Sheet Description:"
                        RtfText="{x:Bind ProblemVm.StructureDescription, Mode=TwoWay}"
                        IsReadOnly="{x:Bind ProblemVm.IsBeatSheetReadOnly}"
                        AcceptsReturn="False"
                        IsSpellCheckEnabled="False"
                        TextWrapping="Wrap"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"
                        HorizontalAlignment="Stretch" />
                                </Expander.Content>
                            </Expander>
                        </Grid>

                        <!-- ===== ROW 1 : BEATS | COMMANDS | ELEMENTS ===== -->
                        <Grid Grid.Row="1"
              ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*" />
                                <!-- beats -->
                                <ColumnDefinition Width="Auto" />
                                <!-- buttons -->
                                <ColumnDefinition Width="2*" />
                                <!-- scenes/problems -->
                            </Grid.ColumnDefinitions>

                            <!-- Beats list (still bound to StructureBeats, SelectedBeat, SelectedBeatIndex) -->
                            <ListView Grid.Column="0"
                      ItemsSource="{x:Bind ProblemVm.StructureBeats, Mode=TwoWay}"
                      SelectedItem="{x:Bind ProblemVm.SelectedBeat, Mode=TwoWay}"
                      SelectedIndex="{x:Bind ProblemVm.SelectedBeatIndex, Mode=TwoWay}"
                      HorizontalAlignment="Stretch">

                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment"
                                Value="Stretch" />
                                    </Style>
                                </ListView.ItemContainerStyle>

                                <ListView.ItemTemplate>
                                    <DataTemplate x:DataType="tools:StructureBeatViewModel">
                                        <!-- Flattened header: icon + title + element name -->
                                        <Grid ColumnDefinitions="Auto,*,Auto"
                              VerticalAlignment="Center"
                              Margin="4">
                                            <SymbolIcon Grid.Column="0"
                                        Symbol="{x:Bind ElementIcon, Mode=OneWay}" />
                                            <TextBox Grid.Column="1"
                                     Text="{x:Bind Title, Mode=TwoWay}"
                                     TextWrapping="NoWrap"
                                     IsReadOnly="{x:Bind ProblemViewModel.IsBeatSheetReadOnly}"
                                     Margin="10,0"
                                     Padding="5,0,20,0" />
                                            <TextBlock Grid.Column="2"
                                       Text="{x:Bind ElementName, Mode=OneWay}"
                                       VerticalAlignment="Center"
                                       TextWrapping="Wrap" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>

                            <!-- Command column (reusing your existing handlers) -->
                            <StackPanel Grid.Column="1"
                        VerticalAlignment="Center"
                        Spacing="4">

                                <!-- New: assign button (no handler wired yet; original used ItemClick) -->
                                <Button x:Name="AssignButton"
                        Content="&lt;"
                        Width="32"
                        Height="32" />

                                <!-- Unassign: same handler as original AppBarButton -->
                                <Button x:Name="UnassignButton"
                        Content="&gt;"
                        Width="32"
                        Height="32"
                        Click="{x:Bind ProblemVm.UnbindElement}" />

                                <Rectangle Height="1"
                                           Fill="{ThemeResource SystemControlForegroundBaseLowBrush}"
                                           Margin="0,8" />

                                <!-- Beatsheet edit buttons: same handlers + visibility -->
                                <Button x:Name="AddBeatButton"
                        Content="+"
                        Width="32"
                        Height="32"
                        Click="{x:Bind ProblemVm.CreateBeat}"
                        Visibility="{x:Bind ProblemVm.BeatsheetEditButtonsVisibility, Mode=OneWay}" />
                                <Button x:Name="DeleteBeatButton"
                        Content="-"
                        Width="32"
                        Height="32"
                        Click="{x:Bind ProblemVm.DeleteBeat}"
                        Visibility="{x:Bind ProblemVm.BeatsheetEditButtonsVisibility, Mode=OneWay}" />

                                <Button x:Name="MoveUpButton"
                        Content="∧"
                        Width="32"
                        Height="32"
                        Click="{x:Bind ProblemVm.MoveUp}"
                        Visibility="{x:Bind ProblemVm.BeatsheetEditButtonsVisibility, Mode=OneWay}" />
                                <Button x:Name="MoveDownButton"
                        Content="∨"
                        Width="32"
                        Height="32"
                        Click="{x:Bind ProblemVm.MoveDown}"
                        Visibility="{x:Bind ProblemVm.BeatsheetEditButtonsVisibility, Mode=OneWay}" />

                                <Button x:Name="SaveBeatSheetButton"
                        Content="S"
                        Width="32"
                        Height="32"
                        Click="{x:Bind ProblemVm.SaveBeatSheet}"
                        Visibility="{x:Bind ProblemVm.BeatsheetEditButtonsVisibility, Mode=OneWay}" />
                            </StackPanel>

                            <!-- Elements list (Scenes / Problems; same bindings) -->
                            <Grid Grid.Column="2"
                  RowSpacing="4">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <!-- Selector for which list is visible (logic to be added later) -->
                                <RadioButtons x:Name="ElementKindSelector"
                              Grid.Row="0"
                              Header="Elements"
                              Margin="0,0,0,4">
                                    <x:String>Scenes</x:String>
                                    <x:String>Problems</x:String>
                                </RadioButtons>

                                <!-- Scenes -->
                                <ListView x:Name="ScenesList"
                          Grid.Row="1"
                          ItemsSource="{x:Bind ProblemVm.Scenes, Mode=TwoWay}"
                          IsItemClickEnabled="True"
                          ItemClick="{x:Bind ProblemVm.AssignBeat}"
                          DisplayMemberPath="Name" />

                                <!-- Problems -->
                                <ListView x:Name="ProblemsList"
                          Grid.Row="1"
                          ItemsSource="{x:Bind ProblemVm.Problems, Mode=TwoWay}"
                          IsItemClickEnabled="True"
                          ItemClick="{x:Bind ProblemVm.AssignBeat}"
                          DisplayMemberPath="Name"
                          Visibility="Collapsed" />
                            </Grid>
                        </Grid>

                        <!-- ===== ROW 2 : DESCRIPTIONS (new, but using existing SelectedBeat properties) ===== -->
                        <Grid Grid.Row="2"
              ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- Beat description for SelectedBeat -->
                            <TextBox Grid.Column="0"
                     Header="Beat Description"
                     Text="{x:Bind ProblemVm.SelectedBeat.Description, Mode=TwoWay}"
                     TextWrapping="Wrap"
                     HorizontalAlignment="Stretch"
                     VerticalAlignment="Stretch"
                     IsReadOnly="{x:Bind ProblemVm.IsBeatSheetReadOnly}" />

                            <Border Grid.Column="1"
                    Width="1"
                    Background="{ThemeResource SystemControlForegroundBaseLowBrush}" />

                            <!-- Element description for SelectedBeat -->
                            <usercontrols:RichEditBoxExtended Grid.Column="2"
                                              Header="Element Description"
                                              HorizontalAlignment="Stretch"
                                              VerticalAlignment="Stretch"
                                              RtfText="{x:Bind ProblemVm.SelectedBeat.ElementDescription, Mode=OneWay}"
                                              IsReadOnly="True"
                                              AcceptsReturn="False"
                                              IsSpellCheckEnabled="False"
                                              TextWrapping="Wrap"
                                              ScrollViewer.VerticalScrollBarVisibility="Auto" />
                        </Grid>
                    </Grid>
                </TabViewItem>


                <TabViewItem Header="Notes" IsClosable="False"
                             HorizontalContentAlignment="Stretch"
                             VerticalContentAlignment="Stretch">
                    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <usercontrols:RichEditBoxExtended Grid.Row="0"
                                                      Header="Notes"
                                                      RtfText="{x:Bind ProblemVm.Notes, Mode=TwoWay}"
                                                      AcceptsReturn="True"
                                                      IsSpellCheckEnabled="True"
                                                      TextWrapping="Wrap"
                                                      VerticalAlignment="Stretch"
                                                      ScrollViewer.VerticalScrollBarVisibility="Auto" />
                    </Grid>
                </TabViewItem>
            </TabView.TabItems>
        </TabView>
    </Grid>
</Page>
